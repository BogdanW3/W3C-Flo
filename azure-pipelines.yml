trigger:
- master

jobs:
- job: server
  pool:
    name: 'Flux Self-hosted'
    demands:
    - agent.os -equals Linux
  steps:
  - script: |
      curl https://sh.rustup.rs/ -sSf | sh -s -- --default-toolchain stable -y
    displayName: 'install rust'
  
  - script: |
      cargo build -p flo-controller-service --release
    displayName: 'build flo controller'

  - script: |
      cargo build -p flo-node-service --release
    displayName: 'build flo node'

  - script: |
      mkdir -p ./build/release &&
      cp ./target/release/flo-controller-service ./build/release/flo-controller-service &&
      cp ./target/release/flo-node-service ./build/release/flo-node-service
    displayName: 'move files for docker'

  - task: Docker@2
    inputs:
      containerRegistry: 'Fluxxu Docker Hub'
      repository: 'fluxxu/flo-controller'
      command: 'buildAndPush'
      Dockerfile: './build/controller.Dockerfile'
      buildContext: "./build"
      tags: |
        $(Build.BuildID)
        latest
  - task: Docker@2
    inputs:
      containerRegistry: 'Fluxxu Docker Hub'
      repository: 'fluxxu/flo-node'
      command: 'buildAndPush'
      Dockerfile: './build/node.Dockerfile'
      buildContext: "./build"
      tags: |
        $(Build.BuildID)
        latest
- job: client_windows
  pool:
    name: 'Flux Self-hosted'
    demands:
    - agent.os -equals Windows_NT
  steps:
  - powershell: |
       Invoke-WebRequest -Uri "https://win.rustup.rs/x86_64" -OutFile "rustup-init.exe"
       ./rustup-init --default-toolchain stable -y
       $env:Path += ";%USERPROFILE%\.cargo\bin"
    displayName: 'install rust'
  
  - powershell: |
      $env:BONJOUR_SDK_HOME="$(Build.Repository.LocalPath)\deps\bonjour-sdk-windows"
      cargo build -p flo-worker --release
    displayName: 'build flo worker'
  
  - powershell: |
      7z a $(Build.ArtifactStagingDirectory)/flo-worker-$(Build.BuildID)-windows.zip ./target/release/flo-worker.exe
    displayName: 'make archive'
  
  - task: GitHubRelease@1
    inputs:
      gitHubConnection: 'modmoto'
      repositoryName: 'w3champions/flo'
      action: 'create'
      target: '$(Build.SourceVersion)'
      tagSource: 'gitTag'
      changeLogCompareToRelease: 'lastFullRelease'
      changeLogType: 'commitBased'
- job: client_macOS
  pool:
    vmImage: 'macOS-latest'
  steps:
  - script: |
      curl https://sh.rustup.rs/ -sSf | sh -s -- --default-toolchain stable -y
    displayName: 'install rust'

  - script: |
      cargo build -p flo-worker --release
    displayName: 'build flo worker'

  - script: |
      zip -j -r $(Build.ArtifactStagingDirectory)/flo-worker-$(Build.BuildID)-macOS.zip target/release/flo-worker

  - task: GitHubRelease@1
    inputs:
      gitHubConnection: 'modmoto'
      repositoryName: 'w3champions/flo'
      action: 'create'
      target: '$(Build.SourceVersion)'
      tagSource: 'gitTag'
      changeLogCompareToRelease: 'lastFullRelease'
      changeLogType: 'commitBased'
